<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supermarket Billing System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: var(--light);
            margin: 8px 0;
            border-radius: 8px;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        .sidebar .nav-link.active {
            background-color: var(--secondary);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary) !important;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: none;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .product-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .low-stock {
            border-left: 4px solid var(--warning);
        }
        
        .out-of-stock {
            border-left: 4px solid var(--danger);
        }
        
        .cart-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
            transition: background-color 0.3s ease;
        }
        
        .cart-item:hover {
            background-color: #f8f9fa;
        }
        
        .bill-receipt {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        }
        
        .search-box {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 12px 20px;
        }
        
        .search-box:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2980b9 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #219a52 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .alert-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .dashboard-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-cash-register me-2"></i>
                SuperMarket Pro
            </a>
            <div class="d-flex align-items-center">
                <span class="me-3 text-muted" id="current-time"></span>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-2"></i>Admin
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('billing')">
                                <i class="fas fa-cash-register me-2"></i>Point of Sale
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('products')">
                                <i class="fas fa-boxes me-2"></i>Products
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('customers')">
                                <i class="fas fa-users me-2"></i>Customers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('inventory')">
                                <i class="fas fa-warehouse me-2"></i>Inventory
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('reports')">
                                <i class="fas fa-chart-bar me-2"></i>Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('alerts')">
                                <i class="fas fa-bell me-2"></i>Alerts
                                <span class="alert-badge" id="alert-badge" style="display: none;">0</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div id="dashboard-section" class="content-section active">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard Overview</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-receipt text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title text-muted mb-0">Today's Sales</h5>
                                        <h2 class="mb-0" id="today-sales">₹0.00</h2>
                                        <small class="text-muted" id="today-transactions">0 transactions</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-shopping-cart text-success"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title text-muted mb-0">Total Products</h5>
                                        <h2 class="mb-0" id="total-products">0</h2>
                                        <small class="text-muted">In inventory</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-users text-warning"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title text-muted mb-0">Customers</h5>
                                        <h2 class="mb-0" id="total-customers">0</h2>
                                        <small class="text-muted">Registered</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="stat-card">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-danger"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="card-title text-muted mb-0">Low Stock</h5>
                                        <h2 class="mb-0" id="low-stock-count">0</h2>
                                        <small class="text-danger">Needs attention</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="stat-card">
                                <h5 class="card-title">Recent Transactions</h5>
                                <div id="recent-transactions">
                                    <p class="text-muted text-center py-4">Loading recent transactions...</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="stat-card">
                                <h5 class="card-title">Quick Actions</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="showSection('billing')">
                                        <i class="fas fa-cash-register me-2"></i>New Sale
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="showSection('products')">
                                        <i class="fas fa-plus me-2"></i>Add Product
                                    </button>
                                    <button class="btn btn-outline-success" onclick="showSection('customers')">
                                        <i class="fas fa-user-plus me-2"></i>Add Customer
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="showSection('inventory')">
                                        <i class="fas fa-boxes me-2"></i>Manage Stock
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="billing-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Point of Sale</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-sm btn-outline-danger" onclick="clearCart()">
                                <i class="fas fa-trash me-1"></i>Clear Cart
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-7">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <input type="text" id="search-product" class="form-control search-box" placeholder="Search by name or scan barcode..." onkeyup="searchProducts()">
                                </div>
                                <div class="col-md-3">
                                    <select id="category-filter" class="form-control" onchange="filterProductsByCategory()">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="products-grid">
                                <p class="text-muted text-center py-5 w-100">Loading products...</p>
                            </div>
                        </div>
                        
                        <div class="col-lg-5">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <select id="customer-id" class="form-control">
                                        <option value="">Guest Customer</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <select id="payment-method" class="form-control">
                                        <option value="cash">Cash</option>
                                        <option value="card">Card</option>
                                        <option value="upi">UPI</option>
                                        <option value="wallet">Wallet</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="stat-card p-3 mb-4">
                                <h5 class="mb-3">Shopping Cart</h5>
                                <div id="cart-items-display">
                                    <div class="text-center py-5 text-muted">
                                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">No items in cart</p>
                                        <small class="text-muted">Click on products or scan barcode to add them to cart</small>
                                    </div>
                                </div>
                                
                                <hr>
                                <form>
                                    <div class="mb-3">
                                        <label class="form-label">Discount (₹)</label>
                                        <input type="number" id="bill-discount" class="form-control" value="0" min="0" step="0.01" onchange="updateCartDisplay()" oninput="updateCartDisplay()">
                                    </div>
                                </form>
                                <hr>
                                
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <strong id="receipt-subtotal">₹0.00</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Discount:</span>
                                    <strong id="receipt-discount">₹0.00</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tax (5%):</span>
                                    <strong id="receipt-tax">₹0.00</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="h4">Total:</span>
                                    <span class="h4 text-success" id="receipt-total">₹0.00</span>
                                </div>
                                
                                <button class="btn btn-success w-100 btn-lg" onclick="checkout()">
                                    <i class="fas fa-dollar-sign me-2"></i>Complete Sale
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="products-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Product Management</h1>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="clearProductModal(true)">
                            <i class="fas fa-plus me-2"></i>Add Product
                        </button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-4">
                            <input type="text" id="product-search-management" class="form-control search-box" placeholder="Search products by name or barcode..." onkeyup="searchProductsManagement()">
                        </div>
                        <div class="col-md-3">
                            <select id="category-filter-management" class="form-control" onchange="filterProductsManagement()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="stock-filter-management" class="form-control" onchange="filterProductsManagement()">
                                <option value="">All Stock Status</option>
                                <option value="in_stock">In Stock</option>
                                <option value="low_stock">Low Stock</option>
                                <option value="out_of_stock">Out of Stock</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Product Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="customers-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Customer Management</h1>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerModal" onclick="clearCustomerModal(true)">
                            <i class="fas fa-plus me-2"></i>Add Customer
                        </button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <input type="text" id="customer-search" class="form-control search-box" placeholder="Search customers by name, email or phone..." onkeyup="searchCustomers()">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Loyalty Points</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="inventory-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Inventory Management & Transactions</h1>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#stockModal" onclick="populateProductSelectors()">
                            <i class="fas fa-plus me-2"></i>Stock Update
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Date</th>
                                    <th>Product</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Employee</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="reports-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Sales Reports</h1>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label class="form-label">Report Type</label>
                            <select id="report-type" class="form-control" onchange="generateReport()">
                                <option value="daily">Daily Sales</option>
                                <option value="monthly">Monthly Sales</option>
                                <option value="product">Top Products</option>
                                <option value="employee">Employee Sales</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Time Period</label>
                            <input type="month" id="report-month" class="form-control" onchange="generateReport()">
                            <input type="date" id="report-date" class="form-control" onchange="generateReport()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-success w-100" onclick="exportReport()">
                                <i class="fas fa-download me-2"></i>Export PDF
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="stat-card">
                                <h5 class="card-title">Sales Report Chart</h5>
                                <div style="height: 400px;"><canvas id="salesChart"></canvas></div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="stat-card">
                                <h5 class="card-title">Report Summary</h5>
                                <div id="report-summary">
                                    <p class="text-muted text-center py-4">Select criteria to generate a report.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="alerts-section" class="content-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">System Alerts</h1>
                    </div>
                    
                    <div class="card stat-card mb-4">
                        <div class="card-body">
                            <h5 class="card-title text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Low Stock Products</h5>
                            <p class="card-text">The following products have low stock and require immediate replenishment.</p>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Product Name</th>
                                            <th>Stock</th>
                                            <th>Category</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="low-stock-table">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="card-body">
                            <h5 class="card-title text-warning"><i class="fas fa-bell me-2"></i>Other System Notifications</h5>
                            <p class="card-text text-muted">No other critical alerts at this moment.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let cart = [];
        let products = [];
        let customers = [];
        let categories = [];
        let transactions = []; // for inventory
        let bills = []; // for reports

        // Utility functions
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${sectionId}-section`).classList.add('active');
            
            // Highlight active sidebar link
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.sidebar .nav-link[onclick="showSection('${sectionId}')"]`).classList.add('active');
            
            // Load data when section is shown
            if (sectionId === 'dashboard') loadDashboardData();
            if (sectionId === 'billing') loadProductsForBilling();
            if (sectionId === 'products') loadProductsForManagement();
            if (sectionId === 'customers') loadCustomers();
            if (sectionId === 'inventory') loadInventoryTransactions();
            if (sectionId === 'reports') generateReport();
            if (sectionId === 'alerts') loadLowStockAlerts();
        }

        // Fetch data wrapper
        async function fetchData(endpoint) {
            const response = await fetch(endpoint);
            if (!response.ok) {
                throw new Error(`Failed to fetch data from ${endpoint}. Status: ${response.status}`);
            }
            return response.json();
        }

        // --- CORE APPLICATION FLOW & INITIALIZATION ---

        async function initApp() {
            // Load all initial data
            await Promise.all([
                loadProducts(), // Load all products into global 'products' array
                loadCategories(),
                loadCustomersForBilling()
            ]);
            
            // Wait for products to load before loading dashboard data (which needs low stock count)
            loadDashboardData();
            
            // Set up event listeners (e.g., for discount field change)
            const discountInput = document.getElementById('bill-discount');
            if (discountInput) {
                discountInput.addEventListener('input', updateCartDisplay);
            }
            
            // Initialize display
            updateCartDisplay();
            updateClock();
            setInterval(updateClock, 1000); // Update time every second
        }

        function updateClock() {
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = new Date().toLocaleString();
            }
        }

        // Load Products into global 'products' array
        async function loadProducts() {
            try {
                products = await fetchData('/api/products');
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        async function loadCategories() {
            try {
                categories = await fetchData('/api/categories');
                populateCategoryFilter();
                // Check if the management filter element exists before populating
                if (document.getElementById('category-filter-management')) {
                    populateCategoryFilterManagement();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadCustomersForBilling() {
            try {
                // Assuming /api/customers fetches all necessary customer data
                customers = await fetchData('/api/customers');
                const customerSelect = document.getElementById('customer-id');
                if (!customerSelect) return;
                
                customerSelect.innerHTML = '<option value="">Guest Customer</option>';
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.customer_id;
                    option.textContent = customer.customer_name + (customer.loyalty_points > 0 ? ` (${customer.loyalty_points} pts)` : '');
                    customerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading customers for billing:', error);
            }
        }
        
        // --- BILLING / CART LOGIC ---
        
        function loadProductsForBilling() {
            displayProducts(products);
        }

        function displayProducts(productsToDisplay) {
            const grid = document.getElementById('products-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            if (productsToDisplay.length === 0) {
                grid.innerHTML = '<p class="text-muted text-center py-5 w-100">No products found.</p>';
                return;
            }

            productsToDisplay.forEach(product => {
                const stockClass = product.stock_quantity <= 0 ? 'out-of-stock' : (product.stock_quantity < 10 ? 'low-stock' : '');
                const isDisabled = product.stock_quantity <= 0 ? 'disabled' : '';
                const productCard = document.createElement('div');
                productCard.className = 'col';
                // Using a lambda function in the onclick handler to pass the product_id
                productCard.innerHTML = `
                    <div class="card product-card h-100 ${stockClass}" onclick="${isDisabled ? '' : `addToCart(${product.product_id})`}" style="${isDisabled ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                        <div class="card-body">
                            <h5 class="card-title">${product.product_name}</h5>
                            <p class="card-text text-muted small mb-2">${product.category_name || 'N/A'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="text-primary mb-0">₹${parseFloat(product.price).toFixed(2)}</h5>
                                <small class="text-muted">Stock: ${product.stock_quantity}</small>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(productCard);
            });
        }
        
        function searchProducts() {
            const query = document.getElementById('search-product').value.toLowerCase();
            const categoryId = document.getElementById('category-filter').value;

            const filteredProducts = products.filter(product => {
                const matchesSearch = product.product_name.toLowerCase().includes(query) || 
                                      (product.barcode && product.barcode.includes(query));
                const matchesCategory = !categoryId || product.category_id == categoryId;
                return matchesSearch && matchesCategory;
            });
            displayProducts(filteredProducts);
        }
        
        function filterProductsByCategory() {
            // Re-run search (which now includes category filter logic)
            searchProducts();
        }

        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('category-filter');
            if (!categoryFilter) return;
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.category_id;
                option.textContent = category.category_name;
                categoryFilter.appendChild(option);
            });
        }
        
        // Placeholder function for management category filter
        function populateCategoryFilterManagement() {
             const categoryFilter = document.getElementById('category-filter-management');
            if (!categoryFilter) return;
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.category_id;
                option.textContent = category.category_name;
                categoryFilter.appendChild(option);
            });
        }


        // --- CORRECTED CART FUNCTIONS ---
        
        function addToCart(productId) {
            const product = products.find(p => p.product_id === productId);
            if (!product) return alert('Product not found!');

            // Check stock
            if (product.stock_quantity <= 0) {
                return alert('❌ Product is out of stock!');
            }

            const existingItemIndex = cart.findIndex(item => item.product_id === productId);

            if (existingItemIndex !== -1) {
                // Update existing item
                const newQuantity = cart[existingItemIndex].quantity + 1;
                
                // Check if new quantity exceeds available stock
                if (newQuantity > product.stock_quantity) {
                    return alert(`Maximum stock (${product.stock_quantity}) reached for ${product.product_name}!`);
                }
                
                cart[existingItemIndex].quantity = newQuantity;
                cart[existingItemIndex].total_price = newQuantity * product.price;
            } else {
                // Add new item
                const newItem = {
                    product_id: productId,
                    product_name: product.product_name,
                    price: parseFloat(product.price), // Ensure price is a number
                    quantity: 1,
                    total_price: parseFloat(product.price) // 1 * price
                };
                cart.push(newItem);
            }
            updateCartDisplay();
        }

        function updateCartItemQuantity(productId, type) {
            const existingItemIndex = cart.findIndex(item => item.product_id === productId);
            if (existingItemIndex === -1) return;

            const item = cart[existingItemIndex];
            const product = products.find(p => p.product_id === productId);

            if (!product) return;

            let newQuantity = item.quantity;

            if (type === 'increment') {
                newQuantity += 1;
                // Stock check on increment
                if (newQuantity > product.stock_quantity) {
                    return alert(`Maximum stock (${product.stock_quantity}) reached for ${item.product_name}!`);
                }
            } else if (type === 'decrement') {
                newQuantity -= 1;
                // Remove item if quantity drops to 0
                if (newQuantity < 1) {
                    removeFromCart(productId);
                    return;
                }
            }
            
            // Update item details
            item.quantity = newQuantity;
            item.total_price = item.quantity * item.price;
            updateCartDisplay();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.product_id !== productId);
            updateCartDisplay();
        }
        
        function clearCart() {
            if (cart.length > 0 && confirm('Are you sure you want to clear the entire cart?')) {
                cart = [];
                const discountInput = document.getElementById('bill-discount');
                if (discountInput) discountInput.value = '0';
                updateCartDisplay();
            }
        }

        function updateCartDisplay() {
            const cartItemsDisplay = document.getElementById('cart-items-display');
            const subtotalElement = document.getElementById('receipt-subtotal');
            const taxElement = document.getElementById('receipt-tax');
            const discountElement = document.getElementById('receipt-discount');
            const totalElement = document.getElementById('receipt-total');
            const discountInput = document.getElementById('bill-discount');
            
            // Safety check for elements
            if (!cartItemsDisplay || !subtotalElement || !taxElement || !discountElement || !totalElement || !discountInput) return;

            // 1. Get Discount value
            const discount = parseFloat(discountInput.value) || 0;
            
            if (cart.length === 0) {
                cartItemsDisplay.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No items in cart</p>
                        <small class="text-muted">Click on products or scan barcode to add them to cart</small>
                    </div>
                `;
                subtotalElement.textContent = '₹0.00';
                taxElement.textContent = '₹0.00';
                discountElement.textContent = '₹0.00';
                totalElement.textContent = '₹0.00';
                return;
            }

            // 2. Calculate Totals
            const subtotal = cart.reduce((sum, item) => sum + item.total_price, 0);

            // Ensure discount doesn't exceed subtotal
            const finalDiscount = Math.min(discount, subtotal);
            // Optional: update the input field to reflect the capped value
            discountInput.value = finalDiscount.toFixed(2); 

            const subtotalAfterDiscount = subtotal - finalDiscount;
            const tax_rate = 0.05; // 5%
            const tax = subtotalAfterDiscount > 0 ? subtotalAfterDiscount * tax_rate : 0;
            const total = subtotalAfterDiscount + tax;

            // 3. Update summary display
            subtotalElement.textContent = `₹${subtotal.toFixed(2)}`;
            discountElement.textContent = `-₹${finalDiscount.toFixed(2)}`;
            taxElement.textContent = `₹${tax.toFixed(2)}`;
            totalElement.textContent = `₹${total.toFixed(2)}`;
            
            // 4. Display cart items
            cartItemsDisplay.innerHTML = '';
            cart.forEach((item) => {
                const product = products.find(p => p.product_id === item.product_id);
                const maxStock = product ? product.stock_quantity : 0;
                const isMaxStock = item.quantity >= maxStock;

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-0">${item.product_name}</h6>
                            <small class="text-muted">₹${item.price.toFixed(2)} / unit</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-danger me-2" onclick="updateCartItemQuantity(${item.product_id}, 'decrement')">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="fw-bold me-2" style="min-width: 20px; text-align: center;">${item.quantity}</span>
                            <button class="btn btn-sm btn-outline-success me-3" onclick="updateCartItemQuantity(${item.product_id}, 'increment')" ${isMaxStock ? 'disabled' : ''}>
                                <i class="fas fa-plus"></i>
                            </button>
                            <span class="text-dark fw-bold" style="min-width: 60px; text-align: right;">₹${item.total_price.toFixed(2)}</span>
                            <button class="btn btn-sm btn-outline-secondary ms-3" onclick="removeFromCart(${item.product_id})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                cartItemsDisplay.appendChild(cartItem);
            });
        }
        
        async function checkout() {
            if (cart.length === 0) {
                alert('Cart is empty. Please add products to checkout.');
                return;
            }

            const employeeId = 1; // Assuming Employee ID 1 is the default cashier
            const customerId = document.getElementById('customer-id').value || null;
            const paymentMethod = document.getElementById('payment-method').value;
            const discount = parseFloat(document.getElementById('bill-discount').value) || 0;
            
            // Get final total from display for a sanity check before payment
            const finalAmountText = document.getElementById('receipt-total').textContent.replace('₹', '');
            const finalAmount = parseFloat(finalAmountText) || 0;

            if (finalAmount < 0) {
                return alert('Cannot checkout. Final amount is negative.');
            }
            
            if (!confirm(`Confirm checkout? Total Payable: ₹${finalAmount.toFixed(2)}`)) {
                return;
            }

            const billData = {
                customer_id: customerId,
                employee_id: employeeId,
                payment_method: paymentMethod,
                discount: discount,
                // Send only necessary cart item details (product_id and quantity)
                items: cart.map(item => ({
                    product_id: item.product_id,
                    quantity: item.quantity
                }))
            };

            try {
                const response = await fetch('/api/bills', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(billData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to create bill.');
                }

                alert(`✅ Bill created successfully! Bill No: ${result.bill.bill_number}`);
                printBillReceipt(result);
                
                // Reset POS state
                cart = [];
                document.getElementById('bill-discount').value = '0';
                const customerSelect = document.getElementById('customer-id');
                if (customerSelect) customerSelect.value = '';
                updateCartDisplay();
                
                // Re-load data to reflect stock changes on the frontend
                await loadProducts(); 
                loadProductsForBilling();
                loadDashboardData();
                
            } catch (error) {
                console.error('Checkout Error:', error);
                alert(`Checkout failed: ${error.message}`);
            }
        }
        
        function printBillReceipt(billData) {
            // Receipt printing logic
            const receiptWindow = window.open('', 'Print Receipt', 'width=400,height=600');
            receiptWindow.document.write(`
                <html>
                <head>
                    <title>Bill Receipt</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; font-size: 12px; }
                        .receipt-container { width: 300px; margin: 0 auto; padding: 10px; border: 1px solid #ccc; }
                        .header { text-align: center; margin-bottom: 10px; }
                        .item { display: flex; justify-content: space-between; margin-bottom: 5px; }
                        .total { font-weight: bold; margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; }
                        .thank-you { text-align: center; margin-top: 10px; font-size: 10px; }
                    </style>
                </head>
                <body>
                    <div class="receipt-container">
                        <div class="header">
                            <h3>SUPERMARKET PRO</h3>
                            <p>Bill: ${billData.bill.bill_number}</p>
                            <p>Date: ${new Date(billData.bill.bill_date).toLocaleString()}</p>
                            <p>Cashier: ${billData.bill.employee_name}</p>
                            <p>Customer: ${billData.bill.customer_name || 'Guest'}</p>
                            <hr>
                        </div>
                        
                        ${billData.items.map(item => `
                            <div class="item">
                                <span>${item.product_name} (${item.quantity} x ${parseFloat(item.unit_price).toFixed(2)})</span>
                                <span>${parseFloat(item.total_price).toFixed(2)}</span>
                            </div>
                        `).join('')}
                        
                        <hr>
                        <div class="item"><span>Subtotal:</span><span>${parseFloat(billData.bill.total_amount).toFixed(2)}</span></div>
                        <div class="item"><span>Discount:</span><span>-${parseFloat(billData.bill.discount).toFixed(2)}</span></div>
                        <div class="item"><span>Tax (5%):</span><span>${parseFloat(billData.bill.tax_amount).toFixed(2)}</span></div>
                        <div class="total item"><strong>Total:</strong><strong>${parseFloat(billData.bill.final_amount).toFixed(2)}</strong></div>
                        <div class="item">Payment: ${billData.bill.payment_method.toUpperCase()}</div>

                        <div class="thank-you">
                            <p>Thank you for your purchase!</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            receiptWindow.document.close();
            receiptWindow.print();
        }

        // --- Placeholder/Mockup functions for other sections (required to prevent errors) ---
        
        async function loadDashboardData() {
            try {
                const totalProducts = products.length;
                const lowStockCount = products.filter(p => p.stock_quantity > 0 && p.stock_quantity < 10).length;
                const totalCustomers = customers.length; 
                
                // Mock sales data
                const todaySales = 12500.50;
                const todayTransactions = 45;
                
                document.getElementById('today-sales').textContent = `₹${todaySales.toFixed(2)}`;
                document.getElementById('today-transactions').textContent = `${todayTransactions} transactions`;
                document.getElementById('total-products').textContent = totalProducts;
                document.getElementById('total-customers').textContent = totalCustomers;
                document.getElementById('low-stock-count').textContent = lowStockCount;
                
                // Mock recent transactions
                document.getElementById('recent-transactions').innerHTML = `
                    <p class="text-success fw-bold mb-1">Bill #00124 - ₹5,200.00 (Card)</p>
                    <p class="text-primary fw-bold mb-1">Bill #00123 - ₹3,150.75 (Cash)</p>
                    <p class="text-warning fw-bold mb-1">Bill #00122 - ₹980.00 (UPI)</p>
                `;
            } catch (error) {
                 console.error('Error loading dashboard data:', error);
            }
        }
        function loadProductsForManagement() { 
            const tableBody = document.getElementById('products-table');
            if (!tableBody) return;
            tableBody.innerHTML = products.map(p => `
                <tr class="${p.stock_quantity <= 0 ? 'table-danger' : (p.stock_quantity < 10 ? 'table-warning' : '')}">
                    <td>${p.product_id}</td>
                    <td>${p.product_name}</td>
                    <td>${p.category_name || 'N/A'}</td>
                    <td>₹${parseFloat(p.price).toFixed(2)}</td>
                    <td>${p.stock_quantity}</td>
                    <td><span class="badge bg-${p.stock_quantity <= 0 ? 'danger' : (p.stock_quantity < 10 ? 'warning' : 'success')}">${p.stock_status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="alert('Edit ${p.product_name}')">Edit</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('product-search-management').value = '';
            document.getElementById('category-filter-management').value = '';
            document.getElementById('stock-filter-management').value = '';
        }
        function searchProductsManagement() { /* ... implementation ... */ }
        function filterProductsManagement() { /* ... implementation ... */ }
        function loadCustomers() { 
            const tableBody = document.getElementById('customers-table');
            if (!tableBody) return;
            tableBody.innerHTML = customers.map(c => `
                <tr>
                    <td>${c.customer_id}</td>
                    <td>${c.customer_name}</td>
                    <td>${c.email || 'N/A'}</td>
                    <td>${c.phone || 'N/A'}</td>
                    <td>${c.loyalty_points}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="alert('Edit ${c.customer_name}')">Edit</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('customer-search').value = '';
        }
        function searchCustomers() { /* ... implementation ... */ }
        function loadInventoryTransactions() { 
            const tableBody = document.getElementById('inventory-table');
            if (!tableBody) return;
            // Mock inventory data
            const mockTransactions = [
                {id: 101, date: '2025-11-18 10:30', product: 'Apple', type: 'IN', quantity: 100, employee: 'Supplier A', notes: 'New stock order'},
                {id: 102, date: '2025-11-19 12:45', product: 'Potato Chips', type: 'OUT', quantity: 5, employee: 'Admin User', notes: 'Sale via Bill-125'},
                {id: 103, date: '2025-11-19 14:00', product: 'Coke 2L', type: 'ADJUST', quantity: -2, employee: 'Manager', notes: 'Damaged stock removal'}
            ];

            tableBody.innerHTML = mockTransactions.map(t => `
                <tr class="${t.type === 'IN' ? 'table-success' : (t.type === 'OUT' ? 'table-danger' : 'table-warning')}">
                    <td>${t.id}</td>
                    <td>${t.date}</td>
                    <td>${t.product}</td>
                    <td><span class="badge bg-${t.type === 'IN' ? 'success' : (t.type === 'OUT' ? 'danger' : 'warning')}">${t.type}</span></td>
                    <td>${t.quantity}</td>
                    <td>${t.employee}</td>
                    <td>${t.notes}</td>
                </tr>
            `).join('');
        }
        function generateReport() { 
            const chartCtx = document.getElementById('salesChart');
            if (!chartCtx) return;
            
            // Mock report data
            const data = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Monthly Sales (₹)',
                    data: [150000, 180000, 165000, 220000, 250000, 280000],
                    backgroundColor: 'rgba(52, 152, 219, 0.5)',
                    borderColor: '#3498db',
                    borderWidth: 1
                }]
            };

            if (window.salesChartInstance) {
                window.salesChartInstance.destroy();
            }

            window.salesChartInstance = new Chart(chartCtx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Mock summary
            document.getElementById('report-summary').innerHTML = `
                <p><strong>Total Sales (YTD):</strong> ₹1,245,000.00</p>
                <p><strong>Total Transactions (YTD):</strong> 4,200</p>
                <p><strong>Highest Selling Product:</strong> Apples</p>
                <p class="text-muted small">Report generated on ${new Date().toLocaleDateString()}</p>
            `;
        }
        function exportReport() { alert('Export to PDF functionality is a placeholder.'); }
        function loadLowStockAlerts() { 
            const lowStockItems = products.filter(p => p.stock_quantity > 0 && p.stock_quantity < 10);
            const tableBody = document.getElementById('low-stock-table');
            const alertBadge = document.getElementById('alert-badge');
            
            if (lowStockItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-success">No low stock alerts. Inventory is healthy!</td></tr>';
                if (alertBadge) {
                    alertBadge.style.display = 'none';
                }
            } else {
                tableBody.innerHTML = lowStockItems.map(p => `
                    <tr>
                        <td>${p.product_name}</td>
                        <td class="text-danger fw-bold">${p.stock_quantity}</td>
                        <td>${p.category_name || 'N/A'}</td>
                        <td><button class="btn btn-sm btn-warning" onclick="alert('Order Stock for ${p.product_name}')">Order</button></td>
                    </tr>
                `).join('');
                if (alertBadge) {
                    alertBadge.textContent = lowStockItems.length;
                    alertBadge.style.display = 'flex';
                }
            }
        }
        function refreshDashboard() { 
            loadProducts().then(() => {
                loadCustomersForBilling().then(() => {
                    loadDashboardData();
                    alert('Dashboard data refreshed.');
                });
            });
        }
        function clearProductModal(isNew) { /* ... implementation ... */ }
        function clearCustomerModal(isNew) { /* ... implementation ... */ }
        function populateProductSelectors() { /* ... implementation ... */ }
        
        // Start the application
        window.onload = initApp;

    </script>
</body>
</html>